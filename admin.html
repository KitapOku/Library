<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore.js";

  document.addEventListener("DOMContentLoaded", () => {
    const firebaseConfig = {
      apiKey: "AIzaSyBBGhn-V58ufgbSGsoL6lLONX09QJKm2sE",
      authDomain: "bibliothek-38373.firebaseapp.com",
      projectId: "bibliothek-38373",
      storageBucket: "bibliothek-38373.firebasestorage.app",
      messagingSenderId: "188405615349",
      appId: "1:188405615349:web:715db2a75ea95cc0c6d3bc",
      measurementId: "G-NR98T0L5RW"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const loginForm = document.getElementById("login-form");
    const adminPanel = document.getElementById("admin-panel");
    const bookForm = document.getElementById("book-form");
    const booksContainer = document.getElementById("books");

    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = loginForm.email.value;
      const password = loginForm.password.value;
      try {
        await signInWithEmailAndPassword(auth, email, password);
        loginForm.style.display = "none";
        adminPanel.style.display = "block";
        loadBooks();
      } catch (err) {
        alert("Login fehlgeschlagen: " + err.message);
      }
    });

    async function loadBooks() {
      booksContainer.innerHTML = "";
      const querySnapshot = await getDocs(collection(db, "books"));
      querySnapshot.forEach((docSnap) => {
        const data = docSnap.data();
        const div = document.createElement("div");
        div.innerHTML = `<strong>${data.title}</strong> von ${data.author}<br>Verf端gbar: ${data.available ? "Ja" : "Nein"}<br>Verf端gbar ab: ${data.availableFrom || "-"}<hr>`;
        booksContainer.appendChild(div);
      });
    }

    bookForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const title = bookForm.title.value;
      const author = bookForm.author.value;
      const cover = bookForm.cover.value;
      const available = bookForm.available.checked;
      const availableFrom = bookForm.availableFrom.value;

      try {
        await addDoc(collection(db, "books"), {
          title,
          author,
          cover,
          available,
          availableFrom,
          createdAt: serverTimestamp()
        });
        alert("Buch hinzugef端gt!");
        bookForm.reset();
        loadBooks();
      } catch (err) {
        alert("Fehler beim Hinzuf端gen: " + err.message);
      }
    });

    onAuthStateChanged(auth, (user) => {
      if (user) {
        loginForm.style.display = "none";
        adminPanel.style.display = "block";
        loadBooks();
      }
    });
  });
</script>

